@page "{id}"
@model BookHavenWebApp.Pages.BookDetailsModel
@{
    ViewData["Title"] = "Product Details";

    //get the cookie
    var recentlyViewed = Request.Cookies["RecentlyViewed"];

    List<string> bookList;
    if(string.IsNullOrEmpty(recentlyViewed))
    {
        bookList = new List<string>
        {
          Model.Id.ToString()
        };
    }
    else
    {
        bookList = recentlyViewed.Split(',').ToList();
        if(!bookList.Contains(Model.Id.ToString()))
        {
            bookList.Add(Model.Id.ToString());
            if(bookList.Count > 8)
            {
                bookList.RemoveAt(0);
            }
        }
    }

    //update the cookie
    var newCookie = string.Join(",", bookList);
    Response.Cookies.Append("RecentlyViewed", newCookie, new CookieOptions
    {
        Expires = DateTimeOffset.UtcNow.AddDays(1) // Cookie expiration time
    });


    // Retrieve details of recently viewed products excluding the current product
    var recentlyViewedBooks = Model.Books
        .Where(v => bookList.Contains(v.Id.ToString()) && v.Id != Model.Id)
        .OrderByDescending(v => bookList.IndexOf(v.Id.ToString()))
        .ToList();



    // Retrieve more vinyls from artist excluding the current product
    var moreBySameAuthor = Model.Books.Where(v => v.Author == Model.Author && v.Id != Model.Id).ToList();

}

<div class="container align-items-stretch mt-5 p-5 px-sm-3 px-md-2 px-lg-5">
    <!-- Success Message -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success" role="alert">
            @TempData["SuccessMessage"]
        </div>
    }

    <div class="row flex-grow-1 justify-content-between align-items-center pt-3 pt-lg-5">
        <!-- Book Image -->
        <div class="col-md-4 d-flex flex-column">
            <img src="/Resources/@Model.ImagePath" class="img-fluid mb-5" alt="Book Cover">
        </div>

        <!-- Book Details -->
        <div class="col-md-8 d-flex flex-column">
            <h2 class="mt-0 pt-0 mb-0" style="text-transform: uppercase; font-weight: bold;">@Model.Title</h2>
            <p><strong>Author:</strong> @Model.Author</p>
            <p><strong>ISBN:</strong> @Model.ISBN</p>
            <p><strong>Published on:</strong> @Model.PublishDate.ToString("dd MMMM yyyy")</p>
            <p><strong>Genre:</strong> @Model.Genre</p>
            <p><strong>Language:</strong> @Model.Language</p>
            @if (Model.DiscountPrice < Model.Price)
            {
                <h2 class="mb-0">
                    <span class="text-danger text-decoration-line-through" style="font-size: 1.5rem; font-weight: 400;">
                        €@Model.Price
                    </span>
                    <span class="fw-bold text-success" style="font-size: 2rem; font-weight: 700; margin-left: 10px;">
                        €@Model.DiscountPrice
                    </span>
                </h2>
            }
            else
            {
                <h2 class="mb-0 fw-bold">€@Model.Price</h2>
            }


            <!-- Add to Cart Button -->
            <div class="row align-items-center">
                <div class="col-10">
                    
                        <form method="post" asp-page-handler="ToCart">
                            <input type="hidden" name="bookId" value="@Model.Id" />
                            <button type="submit" class="btn btn-primary btn-custom my-4 btn-block" style="width: 100%">Add to Cart</button>
                        </form>
                   
                </div>
                
            </div>

            <!-- Additional Book Details for Physical and Audio Books -->
            @if (Model.dimensions != null)
            {
                <p><strong>Dimensions:</strong> @Model.dimensions</p>
                <p><strong>Pages:</strong> @Model.pages</p>
                <p><strong>Cover Type:</strong> @Model.coverType</p>
            }

            @if (Model.FileSize != null)
            {
                <p><strong>Audio Length:</strong> @Model.AudioLength.Hours hours @Model.AudioLength.Minutes minutes</p>
                <p><strong>File Size:</strong> @Model.FileSize</p>
            }
        </div>
    </div>
</div>
<!-- Reviews Section -->
<div class="mt-5">
    <h3>Reviews</h3>

    @if (Model.Reviews != null && Model.Reviews.Count > 0)
    {
        @foreach (LogicLayer.EntityClasses.Review review in Model.Reviews)
        {
            <div class="review border p-3 mb-3">
                <h5>@review.Title</h5>
                <p>
                    <strong>Rating:</strong> @review.Rating/5
                </p>
                @if (!string.IsNullOrEmpty(review.Comment))
                {
                    <p>@review.Comment</p>
                }
                <small class="text-muted">By: @review.Author.FirstName @review.Author.LastName</small>
            </div>
        }
    }
    else
    {
        <p>No reviews yet. Be the first to leave a review!</p>
    }
</div>

<!-- PEOPLE WHO BOUGHT THIS ALSO BOUGHT -->
@if (Model.SimilarBoughtBooks.Count >= 1)
{
    <div class="container mb-5 px-5">
        <div class="row align-items-center">
            <h3 class="display-7 fw-semibold">Customers Also Bought</h3>
            <p class="fs-6 m-0 mb-2">Discover similar picks</p>
        </div>
        <div class="d-flex overflow-auto py-3">
            @foreach (var book in Model.SimilarBoughtBooks)
            {
                <div class="me-3 flex-shrink-0" style="width: 200px;">
                    <a href="/BookDetails/@book.Id" class="text-decoration-none">
                        <div class="card border-0 shadow-sm text-center">
                            <img src="@book.ImagePath" class="card-img-top img-fluid mt-3" alt="@book.Title" style="height: 250px; object-fit: contain;" />
                            <div class="card-body">
                                <h5 class="card-title text-dark">@book.Title</h5>
                                <p class="card-text text-muted">@book.Author</p>
                                <p class="card-text text-primary fw-semibold">€@book.Price</p>
                            </div>
                        </div>
                    </a>
                </div>
            }
        </div>
    </div>
}

<!-- RECENTLY VIEWED BOOKS -->
@if (recentlyViewedBooks.Count >= 1)
{
    <div class="container mb-5 px-5">
        <div class="row align-items-center">
            <h3 class="display-7 fw-semibold">Recently Viewed Books</h3>
            <p class="fs-6 m-0 mb-2">Your Recent Glances</p>
        </div>
        <div class="d-flex overflow-auto py-3">
            @foreach (var book in recentlyViewedBooks)
            {
                <div class="me-3 flex-shrink-0" style="width: 200px;">
                    <a href="/BookDetails/@book.Id" class="text-decoration-none">
                        <div class="card border-0 shadow-sm text-center">
                            <img src="@book.ImagePath" class="card-img-top img-fluid mt-3" alt="@book.Title" style="height: 250px; object-fit: contain;" />
                            <div class="card-body">
                                <h5 class="card-title text-dark">@book.Title</h5>
                                <p class="card-text text-muted">@book.Author</p>
                                <p class="card-text text-primary fw-semibold">€@book.Price</p>
                            </div>
                        </div>
                    </a>
                </div>
            }
        </div>
    </div>
}
<style>
    .d-flex.overflow-auto {
        scroll-behavior: smooth;
        scrollbar-width: thin;
    }

        .d-flex.overflow-auto::-webkit-scrollbar {
            height: 8px;
        }

        .d-flex.overflow-auto::-webkit-scrollbar-thumb {
            background-color: #007bff;
            border-radius: 4px;
        }

        .d-flex.overflow-auto::-webkit-scrollbar-track {
            background-color: #f1f1f1;
        }
</style>


